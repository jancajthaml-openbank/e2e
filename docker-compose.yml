version: '2'

# ---------------------------------------------------------------------------- #

services:

  # -------------------------------------------------------------------------- #

  candidate:
    build:
      context: .
      dockerfile: Dockerfile
    image: openbankdev/e2e_candidate

  # -------------------------------------------------------------------------- #

  bbtest:
    build:
      context: .
      dockerfile: bbtest/Dockerfile
    image: e2e/bbtest
    working_dir: /opt/bbtest
    environment:
      - COMPOSE_PROJECT_NAME
    volumes:
      - ./reports:/reports
      - journal:/data
      - ./bbtest:/opt/bbtest
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers

  # -------------------------------------------------------------------------- #

  perf:
    build:
      context: .
      dockerfile: perf/Dockerfile
    image: e2e/perf
    working_dir: /opt/perf
    environment:
      - COMPOSE_PROJECT_NAME
    volumes:
      - ./reports:/reports
      - journal:/data
      - ./perf:/opt/perf
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers

  # -------------------------------------------------------------------------- #

  search:
    image: openbank/search:master
    restart: unless-stopped
    container_name: e2e_search
    environment:
      - SEARCH_HTTP_PORT=8080
      - SEARCH_LAKE_HOSTNAME=lake
      - SEARCH_MONGO_HOSTNAME=e2e_mongodb
      - SEARCH_TENANT=test
    ports:
      - "8080"
    logging:
      driver: json-file

  # -------------------------------------------------------------------------- #

  mongodb:
    image: mongo:latest
    restart: "no"
    container_name: e2e_mongodb
    environment:
      - MONGO_DATA_DIR=/data/db
      - MONGO_LOG_DIR=/dev/null
    volumes:
      - mongo:/data/db
    ports:
      - "27017:27017"
    entrypoint: ["mongod"]
    command: ["--smallfiles", "--logpath=/dev/null"]

# ---------------------------------------------------------------------------- #

volumes:

  journal:
    driver: local
  mongo:
    driver: local

# ---------------------------------------------------------------------------- #
